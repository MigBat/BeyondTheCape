########################################
# Civil War in Castile
# Mix of Castilian Civil Wars involving
# nobles and outside intervention
########################################

namespace = castilian_civil_war

# Civil War in Castile
country_event = {
	id = castilian_civil_war.1
	title = "castilian_civil_war.1.t"
	desc = "castilian_civil_war.1.d"
	picture = CIVIL_WAR_eventPicture

	is_triggered_only = yes

	major = yes
	
	mean_time_to_happen = {
		days = 1
	}
	
	immediate = {
		set_country_flag = had_cas_civil_war
		add_stability = -2

		every_owned_province = {
			limit = { has_province_modifier = strong_nobility }
			remove_province_modifier = strong_nobility
		}

		hidden_effect = {
			random_owned_province = {
				limit = {
					is_capital = no
					has_building = fort_15th
				}
				set_province_flag = cas_civil_war_start
			}
			random_owned_province = {
				limit = {
					is_capital = no
					NOT = { has_province_flag = cas_civil_war_start } 
				}
				set_province_flag = cas_civil_war_2
			}
			random_owned_province = {
				limit = {
					is_capital = no
					NOT = { has_province_flag = cas_civil_war_start } 
					NOT = { has_province_flag = cas_civil_war_2 } 
				}
				set_province_flag = cas_civil_war_3
			}
		}
	}
	
	option = {		# Support Joanna
		name = "castilian_civil_war.1a"

		set_country_flag = civil_war_in_castile

		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				POR = { has_regency = yes }
			}
			modifier = {
				factor = 0.1
				is_rival = POR
			}
			modifier = {
				factor = 2
				alliance_with = POR
			}
			modifier = {
				factor = 0
				POR = {
					NOT = { government = monarchy }
				}
			}
		}

		ARA = {
			add_opinion = {
				who = CAS
				modifier = chose_other_candidate # -100 relation
			}
		}

		POR = {
			country_event = { id = castilian_civil_war.2 days = 30 }
		}

		random_owned_province = {
			limit = {
				has_province_flag = cas_civil_war_start
			}
			spawn_rebels = {
				type = noble_rebels
				friend = ARA
				size = 1
				win = yes
			}
			clr_province_flag = cas_civil_war_start
		}
	}

	option = {		# Support Isabella
		name = "castilian_civil_war.1b"

		set_country_flag = civil_war_in_castile

		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				ARA = { has_regency = yes }
			}
			modifier = {
				factor = 0.1
				is_rival = ARA
			}
			modifier = {
				factor = 2
				alliance_with = ARA
			}
			modifier = {
				factor = 0
				ARA = {
					NOT = { government = monarchy }
				}
			}
		}

		POR = {
			add_opinion = {
				who = CAS
				modifier = chose_other_candidate # -100 relation
			}
		}

		ARA = {
			country_event = { id = castilian_civil_war.3 days = 30 }
		}

		random_owned_province = {
			limit = {
				has_province_flag = cas_civil_war_start
			}
			spawn_rebels = {
				type = noble_rebels
				friend = POR
				size = 1
				win = yes
			}
			clr_province_flag = cas_civil_war_start
		}
	}
}

# Castile supports Joanna's claim (POR)
country_event = {
	id = castilian_civil_war.2
	title = "castilian_civil_war.2.t"
	desc = "castilian_civil_war.2.d"
	picture = REFORM_eventPicture
	
	is_triggered_only = yes
	
	option = { # Press the claim
		name = "castilian_civil_war.2a"

		trigger = {
			NOT = { has_regency = yes }
		}
		
		ai_chance = {
			factor = 90
		}

		set_country_flag = pressed_claim

		define_consort = {
			country_of_origin = CAS
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 15
			culture = castillian
			adm = 5
			dip = 5
			mil = 4
			female = yes
		}
		set_ruler_flag = joanna

		set_consort_flag = joanna

		add_opinion = {
			who = CAS
			modifier = chose_our_candidate # 100 relation
		}

		CAS = {
			country_event = { id = castilian_civil_war.4 days = 15 } # Joanna de Avis
		}
	}

	option = { # Disregard the claim
		name = "castilian_civil_war.2b"

		ai_chance = {
			factor = 10
		}

		add_prestige = -10
		hidden_effect = {
			set_country_flag = disregarded_claim
		}

		CAS = {
			country_event = { id = castilian_civil_war.5 days = 15 } # Joanna de Castile
		}
	}
}

# Castile supports Isabella's claim (ARA)
country_event = {
	id = castilian_civil_war.3
	title = "castilian_civil_war.3.t"
	desc = "castilian_civil_war.3.d"
	picture = REFORM_eventPicture
	
	is_triggered_only = yes
	
	option = { # Press the claim
		name = "castilian_civil_war.3a"

		trigger = {
			NOT = { has_regency = yes }
		}

		ai_chance = {
			factor = 99
		}

		set_country_flag = pressed_claim
		
		define_consort = {
			country_of_origin = CAS
			name = "Isabella"
			dynasty = "de Trastámara"
			age = 24
			culture = castillian
			adm = 5
			dip = 6
			mil = 3
			female = yes
		}
		set_ruler_flag = isabella

		add_opinion = {
			who = CAS
			modifier = chose_our_candidate # 100 relation
		}

		CAS = {
			country_event = { id = castilian_civil_war.6 days = 15 } # Isabella de Trastámara
		}
	}

	option = { # Disregard the claim
		name = "castilian_civil_war.3b"

		ai_chance = {
			factor = 1
		}

		add_prestige = -10

		CAS = {
			country_event = { id = castilian_civil_war.7 days = 15 } # Isabella de Castile
		}
	}
}

# Joanna de Avis
country_event = {
	id = castilian_civil_war.4
	title = "castilian_civil_war.4.t"
	desc = "castilian_civil_war.4.d"
	picture = NEW_HEIR_eventPicture
	
	is_triggered_only = yes
	
	option = { # A new Queen!
		name = "castilian_civil_war.4a"

		define_ruler = {
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 15
			culture = castillian
			adm = 5
			dip = 5
			mil = 4
			claim = 50
			female = yes
		}

		set_ruler_flag = joanna

		define_consort = {
			name = "Ruler of Portugal"
			dynasty = "de Avis"
			age = 15
			male = yes
		}

		define_heir = {
			name = "Isabel"
			dynasty = "de Avis"
			age = 0
			culture = portugese
			adm = 3
			dip = 4
			mil = 5
			claim = 70
			female = yes
		}

		set_heir_flag = isabel

		POR = {
			define_heir = {
				name = "Isabel"
				dynasty = "de Avis"
				age = 0
				culture = portugese
				adm = 3
				dip = 4
				mil = 5
				claim = 70
				female = yes
			}
			set_heir_flag = isabel
		}
		
		add_opinion = {
			who = POR
			modifier = chose_our_candidate # 100 relation
		}

		create_marriage = POR
		create_alliance = POR
		add_historical_friend = POR
		remove_rival = POR
		add_trust = {
			who = POR
			value = 30
		}
		POR = { 
			add_historical_friend = CAS 
			remove_rival = CAS
			add_trust = {
				who = CAS
				value = 30
			}
		}

		ARA = {
			country_event = { id = castilian_civil_war.9 days = 30 } # Contest Joanna's claim
		}
	}
}

# Joanna de Castile
country_event = {
	id = castilian_civil_war.5
	title = "castilian_civil_war.5.t"
	desc = "castilian_civil_war.5.d"
	picture = GOOD_WITH_MONARCH_eventPicture
	
	is_triggered_only = yes
	
	option = { # A new Queen!
		name = "castilian_civil_war.5a"

		define_ruler = {
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 15
			culture = castillian
			adm = 5
			dip = 5
			mil = 4
			claim = 50
			female = yes
		}

		ARA = {
			country_event = { id = castilian_civil_war.9 days = 30 } # Contest Joanna's claim
		}
	}
}

# Isabella de Trastámara
country_event = {
	id = castilian_civil_war.6
	title = "castilian_civil_war.6.t"
	desc = "castilian_civil_war.6.d"
	picture = NEW_HEIR_eventPicture
	
	is_triggered_only = yes
	
	option = { # A new Queen!
		name = "castilian_civil_war.6a"

		define_ruler = {
			name = "Isabella"
			dynasty = "de Trastámara"
			age = 24
			culture = castillian
			adm = 5
			dip = 6
			mil = 3
			claim = 50
			female = yes
		}

		set_ruler_flag = isabella

		define_consort = {
			name = "Ruler of Aragon"
			dynasty = "de Trastámara"
			age = 15
			male = yes
		}

		define_heir = {
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 0
			culture = aragonese
			adm = 3
			dip = 6
			mil = 3
			claim = 70
			female = yes
		}

		set_heir_flag = joanna

		ARA = {
			define_heir = {
				name = "Joanna"
				dynasty = "de Trastámara"
				age = 0
				culture = aragonese
				adm = 3
				dip = 6
				mil = 3
				claim = 70
				female = yes
			}
			set_heir_flag = joanna
		}

		add_opinion = {
			who = ARA
			modifier = chose_our_candidate # 100 relation
		}

		create_marriage = ARA
		create_alliance = ARA
		add_historical_friend = ARA
		remove_rival = ARA
		add_trust = {
			who = ARA
			value = 30
		}
		ARA = { 
			add_historical_friend = CAS 
			remove_rival = CAS
			add_trust = {
				who = CAS
				value = 30
			}
		}

		POR = {
			country_event = { id = castilian_civil_war.8 days = 30 } # Contest Isabella's claim
		}
	}
}

# Isabella de Castile
country_event = {
	id = castilian_civil_war.7
	title = "castilian_civil_war.7.t"
	desc = "castilian_civil_war.7.d"
	picture = GOOD_WITH_MONARCH_eventPicture
	
	is_triggered_only = yes
	
	option = { # A new Queen!
		name = "castilian_civil_war.7a"
		define_ruler = {
			name = "Isabella"
			dynasty = "de Trastámara"
			age = 24
			culture = castillian
			adm = 5
			dip = 6
			mil = 3
			claim = 50
			female = yes
		}

		POR = {
			country_event = { id = castilian_civil_war.8 days = 30 } # Contest Isabella's claim
		}
	}
}

# Contest Isabella's claim (POR)
country_event = {
	id = castilian_civil_war.8
	title = "castilian_civil_war.8.t"
	desc = "castilian_civil_war.8.d"
	picture = BAD_WITH_MONARCH_eventPicture
	
	is_triggered_only = yes
	
	option = { # We will fight for Joanna's right
		name = "castilian_civil_war.8a"

		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				has_regency = yes
				is_at_war = yes
			}
		}

		set_country_flag = pressed_claim

		define_consort = {
			country_of_origin = CAS
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 15
			culture = castillian
			adm = 5
			dip = 5
			mil = 4
			female = yes
		}

		set_ruler_flag = joanna

		declare_war_with_cb = {
			who = CAS
			casus_belli = cb_castilian_civil_war
		}

		set_country_flag = at_war
		CAS = {
			set_country_flag = at_war
		}

		FRA = {
			country_event = { id = castilian_civil_war.10 days = 90 } # Support Portugal in the war
		}
	}

	option = { # Avoid involvement
		name = "castilian_civil_war.8b"

		ai_chance = {
			factor = 1
		}

		add_prestige = -10

		CAS = {
			set_country_flag = no_contest
			random_owned_province = {
				limit = {
					has_province_flag = cas_civil_war_2
				}
				spawn_rebels = {
					type = pretender_rebels
					friend = POR
					size = 3
					leader = "Joanna"
					leader_dynasty = "de Trastámara"
					female = yes
					win = yes
				}
				clr_province_flag = cas_civil_war_2
			}
			random_owned_province = {
				limit = {
					has_province_flag = cas_civil_war_3
				}
				spawn_rebels = {
					type = pretender_rebels
					size = 2
					win = yes
				}
				clr_province_flag = cas_civil_war_3
			}
		}
	}
}

# Contest Joanna's claim (ARA)
country_event = {
	id = castilian_civil_war.9
	title = "castilian_civil_war.9.t"
	desc = "castilian_civil_war.9.d"
	picture = BAD_WITH_MONARCH_eventPicture
	
	is_triggered_only = yes
	
	option = { # We will fight for Isabella's right
		name = "castilian_civil_war.9a"

		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				has_regency = yes
				is_at_war = yes
			}
		}

		set_country_flag = pressed_claim
		
		define_consort = {
			country_of_origin = CAS
			name = "Isabella"
			dynasty = "de Trastámara"
			age = 24
			culture = castillian
			adm = 5
			dip = 6
			mil = 3
			female = yes
		}

		set_ruler_flag = isabella

		declare_war_with_cb = {
			who = CAS
			casus_belli = cb_castilian_civil_war
		}

		set_country_flag = at_war
		CAS = {
			set_country_flag = at_war
		}

		if = {
			limit = {
				POR = {
					has_consort_flag = joanna
				}
			}
			FRA = {
				country_event = { id = castilian_civil_war.10 days = 90 } # Support Portugal in the war
			}
		}
	}

	option = { # Avoid involvement
		name = "castilian_civil_war.9b"

		ai_chance = {
			factor = 1
		}

		add_prestige = -10

		CAS = {
			set_country_flag = no_contest
			random_owned_province = {
				limit = {
					has_province_flag = cas_civil_war_2
				}
				spawn_rebels = {
					type = pretender_rebels
					friend = ARA
					size = 3
					leader = "Isabella"
					leader_dynasty = "de Trastámara"
					female = yes
					win = yes
				}
				clr_province_flag = cas_civil_war_2
			}
			random_owned_province = {
				limit = {
					has_province_flag = cas_civil_war_3
				}
				spawn_rebels = {
					type = pretender_rebels
					size = 2
					win = yes
				}
				clr_province_flag = cas_civil_war_3
			}
		}
	}
}

# Support Portugal in the war (FRA)

country_event = {
	id = castilian_civil_war.10
	title = "castilian_civil_war.10.t"
	desc = "castilian_civil_war.10.d"
	picture = DIPLOMACY_eventPicture
	
	is_triggered_only = yes
	
	option = { # We will support Portugal
		name = "castilian_civil_war.10a"

		ai_chance = {
			factor = 0.8
			modifier = {
				factor = 0
				war_with = POR
			}
		}

		add_manpower = -10
		add_years_of_income = -0.2
		add_permanent_claim = 197

		POR = {
			country_event = { id = castilian_civil_war.11 days = 20 } # Support from France
		}
	}

	option = { # Avoid involvement
		name = "castilian_civil_war.10b"

		ai_chance = {
			factor = 0.2
		}

		add_prestige = -10
	}
}

# Support from France (POR)

country_event = {
	id = castilian_civil_war.11
	title = "castilian_civil_war.11.t"
	desc = "castilian_civil_war.11.d"
	picture = BATTLE_eventPicture
	
	is_triggered_only = yes
	
	option = { # We can fight better now
		name = "castilian_civil_war.11a"

		ai_chance = {
			factor = 1
		}

		add_manpower = 10

		define_general = {
			name = "Alain d'Albret"
			shock = 5
			fire = 2
			manuever = 2
			siege = 0
		}

		FRA = {
			add_opinion = {
				who = POR
				modifier = supported_us # 50 relation
			}
		}
	}

	option = { # We can plan better now
		name = "castilian_civil_war.11b"

		ai_chance = {
			factor = 1
		}

		add_manpower = 10

		define_advisor = {
			name = "Alain d'Albret"
			type = army_reformer
			skill = 2
			culture = cosmopolitan_french
			religion = catholic
			cost_multiplier = 0.5
		}

		FRA = {
			add_opinion = {
				who = POR
				modifier = supported_us # 50 relation
			}
		}
	}
}

# Galicia joins Portugal #

country_event = {
	id = castilian_civil_war.17
	title = castilian_civil_war.17_t
	desc = castilian_civil_war.17_d
	picture = ANGRY_MOB_eventPicture

	major = yes
	fire_only_once = yes

	trigger = {
		tag = POR
		has_country_flag = helped_galicia
		galicia_area = {
			owned_by = CAS
			controlled_by = POR
		}
		CAS = { has_disaster = castilian_civil_war }
		POR = { war_with = CAS }
	}

	mean_time_to_happen = {
		days = 30
	}

	option = {	# accept them
		name = castilian_civil_war.17a
		
		ai_chance = {
			factor = 0.5
		}

		CAS = { release = GAL }
		POR = { vassalize = GAL }
	}

	option = {	# let them be
		name = castilian_civil_war.17b

		ai_chance = {
			factor = 0.5
		}

		add_prestige = 1
	}
}

# Portugal wins War of Castilian Succession (POR)

country_event = {
	id = castilian_civil_war.12
	title = "castilian_civil_war.12.t"
	desc = "castilian_civil_war.12.d"
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.12a"

		clr_country_flag = at_war
		CAS = { 
			clr_country_flag = at_war 
			set_country_flag = lost_war
		}

		if = { 
			limit = { ARA = { has_country_flag = at_war } }
			ARA = { 
				clr_country_flag = at_war
				set_country_flag = lost_war 
			}
		}

		define_heir = {
			name = "Isabel"
			dynasty = "de Avis"
			age = 0
			culture = portugese
			adm = 3
			dip = 4
			mil = 5
			claim = 70
			female = yes
		}

		set_heir_flag = isabel

		CAS = {
			define_ruler = {
				name = "Joanna"
				dynasty = "de Trastámara"
				age = 15
				culture = castillian
				adm = 5
				dip = 5
				mil = 4
				claim = 50
				female = yes
			}
			clr_ruler_flag = isabella
			set_ruler_flag = joanna
			define_consort = {
				name = "Ruler of Portugal"
				dynasty = "de Avis"
				age = 15
				male = yes
			}
			define_heir = {
				name = "Isabel"
				dynasty = "de Avis"
				age = 0
				culture = portugese
				adm = 3
				dip = 4
				mil = 5
				claim = 70
				female = yes
			}
			set_heir_flag = isabel
		}

		POR = {
			remove_rival = CAS
			add_trust = {
				who = CAS
				value = 30
			}
			create_alliance = CAS
			create_marriage = CAS
			add_historical_friend = CAS
			add_opinion = {
				who = CAS
				modifier = iberian_wedding # 200 relation
			}
			set_country_flag = won_castilian_civil_war
		}

		CAS = { 
			remove_rival = POR
			add_trust = {
				who = POR
				value = 30
			}
			add_historical_friend = POR
			set_country_flag = civil_war_ended
			add_opinion = {
				who = POR
				modifier = iberian_wedding # 200 relation
			}
		}

		if = {
			limit = {
				ARA = { has_ruler_flag = isabella }
			}
			ARA = { 
				kill_consort = yes 
				kill_heir = { allow_new_heir = yes }
			}
		}
	}
}

# Aragon wins War of Castilian Succession (ARA)

country_event = {
	id = castilian_civil_war.13
	title = "castilian_civil_war.13.t"
	desc = "castilian_civil_war.13.d"
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.13a"

		clr_country_flag = at_war
		CAS = { 
			clr_country_flag = at_war 
			set_country_flag = lost_war
		}

		if = { 
			limit = { POR = { has_country_flag = at_war } }
			POR = { 
				clr_country_flag = at_war 
				set_country_flag = lost_war
			}
		}

		define_heir = {
			name = "Joanna"
			dynasty = "de Trastámara"
			age = 0
			culture = aragonese
			adm = 3
			dip = 6
			mil = 3
			claim = 70
			female = yes
		}

		set_heir_flag = joanna

		CAS = {
			define_ruler = {
				name = "Isabella"
				dynasty = "de Trastámara"
				age = 24
				culture = castillian
				adm = 5
				dip = 6
				mil = 3
				claim = 50
				female = yes
			}
			clr_ruler_flag = joanna
			set_ruler_flag = isabella
			define_consort = {
				name = "Ruler of Aragon"
				dynasty = "de Trastámara"
				age = 15
				male = yes
			}
			define_heir = {
				name = "Joanna"
				dynasty = "de Trastámara"
				age = 0
				culture = aragonese
				adm = 3
				dip = 6
				mil = 3
				claim = 70
				female = yes
			}
			set_heir_flag = joanna
		}

		ARA = {
			remove_rival = CAS
			add_trust = {
				who = CAS
				value = 30
			}
			create_alliance = CAS
			create_marriage = CAS
			add_historical_friend = CAS
			add_opinion = {
				who = CAS
				modifier = iberian_wedding # 200 relation
			}
			set_country_flag = won_castilian_civil_war
		}

		CAS = { 
			remove_rival = ARA
			add_trust = {
				who = ARA
				value = 30
			}
			add_historical_friend = ARA
			set_country_flag = civil_war_ended
			add_opinion = {
				who = ARA
				modifier = iberian_wedding # 200 relation
			}
		}

		if = {
			limit = {
				POR = { has_ruler_flag = joanna }
			}
			POR = { 
				kill_consort = yes 
				kill_heir = { allow_new_heir = yes }
			}
		}
	}
}

# Castile wins War of Castilian Succession

country_event = {
	id = castilian_civil_war.14
	title = "castilian_civil_war.14.t"
	desc = "castilian_civil_war.14.d"
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.14a"

		set_country_flag = won_war
		clr_country_flag = at_war
		set_country_flag = civil_war_ended
		set_country_flag = won_castilian_civil_war

		if = { 
			limit = { ARA = { has_country_flag = at_war } }
			ARA = { 
				kill_consort = yes
				set_country_flag = lost_war
			}
		}
		if = { 
			limit = { POR = { has_country_flag = at_war } }
			POR = { 
				kill_consort = yes
				set_country_flag = lost_war
			}
		}
	}
}

# Portugal and Castile win War of Castilian Succession

country_event = {
	id = castilian_civil_war.15
	title = "castilian_civil_war.15.t"
	desc = "castilian_civil_war.15.d"
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.15a"

		trigger = { tag = POR }

		clr_country_flag = at_war
		set_country_flag = won_castilian_civil_war
		ARA = { 
			clr_country_flag = at_war 
			clr_ruler_flag = isabella
			set_country_flag = lost_war
		}
	}

	option = {
		name = "castilian_civil_war.15b"

		trigger = { tag = CAS }

		clr_country_flag = at_war
		set_country_flag = won_war
		set_country_flag = won_castilian_civil_war
		set_country_flag = civil_war_ended
	}
}

# Aragon and Castile win War of Castilian Succession

country_event = {
	id = castilian_civil_war.16
	title = "castilian_civil_war.16.t"
	desc = "castilian_civil_war.16.d"
	picture = CONQUEST_eventPicture
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.16a"

		trigger = { tag = ARA }

		clr_country_flag = at_war
		set_country_flag = won_castilian_civil_war
		POR = { 
			clr_country_flag = at_war 
			clr_ruler_flag = joanna
			set_country_flag = lost_war
		}
	}

	option = {
		name = "castilian_civil_war.16b"

		trigger = { tag = CAS }

		clr_country_flag = at_war
		set_country_flag = won_war
		set_country_flag = won_castilian_civil_war
		set_country_flag = civil_war_ended
	}
}

# End of Castilian Civil War
country_event = {
	id = castilian_civil_war.100
	title = "castilian_civil_war.100.t"
	desc = "castilian_civil_war.100.d"
	picture = CIVIL_WAR_eventPicture

	major = yes
	
	is_triggered_only = yes

	option = {
		name = "castilian_civil_war.100a" # Castile Wins War

		trigger = { 
			CAS = { 
				OR = {
					has_country_flag = won_war
					AND = {
						has_country_flag = no_contest
						NOT = { has_country_flag = cas_civil_war_rebels_won }
					}
				}
			}
		}
		add_stability = 1
		hidden_effect = {
			if = {
				limit = {
					POR = {
						has_heir_flag = isabel
					}
				}
				POR = { set_country_flag = won_castilian_civil_war }
			}
			if = {
				limit = {
					ARA = {
						has_heir_flag = joanna
					}
				}
				ARA = { set_country_flag = won_castilian_civil_war }
			}
		}
	}

	option = {
		name = "castilian_civil_war.100b" # Castile Loses War

		trigger = { 
			CAS = {
				OR = {
					has_country_flag = lost_war
					AND = {
						has_country_flag = no_contest
						has_country_flag = cas_civil_war_rebels_won
					}
				}
			}
		}
		add_stability = -1		
	}
}

# Informing of Iberian Inheritance (CAS) #

country_event = {
	id = castilian_civil_war.28
	title = castilian_civil_war.28.t
	desc = castilian_civil_war.28.d
	picture = GOOD_WITH_MONARCH_eventPicture

	fire_only_once = yes

	trigger = {
		tag = CAS
		NOT = { has_disaster = castilian_civil_war }
		OR = {
			has_ruler_flag = joanna
			has_ruler_flag = isabella
		}
	}

	mean_time_to_happen = {
		days = 1
	}

	option = { name = castilian_civil_war.28a }
}

# Informing of Iberian Inheritance (POR/ARA) #

country_event = {
	id = castilian_civil_war.29
	title = castilian_civil_war.29.t
	desc = castilian_civil_war.29.d
	picture = GOOD_WITH_MONARCH_eventPicture

	fire_only_once = yes

	trigger = {
		NOT = { tag = CAS }
		CAS = { NOT = { has_disaster = castilian_civil_war } }
		OR = {
			has_ruler_flag = joanna
			has_ruler_flag = isabella
		}
	}
	
	mean_time_to_happen = {
		days = 1
	}

	option = { name = castilian_civil_war.29a }
}

# Iberian Inheritance

country_event = {
	id = castilian_civil_war.30
	title = "castilian_civil_war.30.t"
	desc = "castilian_civil_war.30.d"
	picture = COURT_eventPicture

	major = yes
	fire_only_once = yes
	is_triggered_only = yes

	mean_time_to_happen = {
		days = 1
	}

	option = {	# Castile forms union over Portugal
		name = "castilian_civil_war.30a"

		trigger = {
			OR = {
				AND = {
					POR = { has_heir_flag = isabel }
					CAS = { has_ruler_flag = isabel }
				}
				AND = {
					CAS = { has_heir_flag = isabel }
					POR = { has_ruler_flag = isabel }
				}
				AND = {
					CAS = { has_ruler_flag = isabel }
					POR = { has_ruler_flag = isabel }
				}
			}
			OR = {
				prestige = POR
				legitimacy = POR
			}
		}

		if = {
			limit = {
				POR = { has_ruler_flag = joanna }
			}
			POR = { kill_ruler = yes }
		}
		if = {
			limit = {
				CAS = { has_ruler_flag = joanna }
			}
			CAS = { kill_ruler = yes }
		}
		create_union = POR
	}

	option = {	# Castile forms union over Aragon
		name = "castilian_civil_war.30b"

		trigger = {
			OR = {
				AND = {
					ARA = { has_heir_flag = joanna }
					CAS = { has_ruler_flag = joanna }
				}
				AND = {
					CAS = { has_heir_flag = joanna }
					ARA = { has_ruler_flag = joanna }
				}
				AND = {
					CAS = { has_ruler_flag = joanna }
					ARA = { has_ruler_flag = joanna }
				}
			}
			OR = {
				OR = {
					prestige = ARA
					legitimacy = ARA
				}
				AND = {
					ai = yes
					ARA = { ai = yes }
				}
			}
		}

		if = {
			limit = {
				ARA = { has_ruler_flag = isabella }
			}
			ARA = { kill_ruler = yes }
		}
		if = {
			limit = {
				CAS = { has_ruler_flag = isabella }
			}
			CAS = { kill_ruler = yes }
		}
		create_union = ARA
	}

	option = {	# Portugal forms union over Castile
		name = "castilian_civil_war.30c"

		trigger = {
			OR = {
				AND = {
					POR = { has_heir_flag = isabel }
					CAS = { has_ruler_flag = isabel }
				}
				AND = {
					CAS = { has_heir_flag = isabel }
					POR = { has_ruler_flag = isabel }
				}
				AND = {
					CAS = { has_ruler_flag = isabel }
					POR = { has_ruler_flag = isabel }
				}
			}
			AND = { 
				NOT = { prestige = POR }
				NOT = { legitimacy = POR }
			}
		}

		if = {
			limit = {
				POR = { has_ruler_flag = joanna }
			}
			POR = { kill_ruler = yes }
		}
		if = {
			limit = {
				CAS = { has_ruler_flag = joanna }
			}
			CAS = { kill_ruler = yes }
		}
		POR = { create_union = CAS }
	}

	option = {	# Aragon forms union over Castile
		name = "castilian_civil_war.30d"

		trigger = {
			OR = {
				AND = {
					ARA = { has_heir_flag = joanna }
					CAS = { has_ruler_flag = joanna }
				}
				AND = {
					CAS = { has_heir_flag = joanna }
					ARA = { has_ruler_flag = joanna }
				}
				AND = {
					CAS = { has_ruler_flag = joanna }
					ARA = { has_ruler_flag = joanna }
				}
			}
			AND = {
				NOT = { prestige = ARA }
				NOT = { legitimacy = ARA }
				OR = {
					ARA = { ai = no }			
					AND = {
						ai = no
						ARA = { ai = yes }
					}		
				}
			}
		}

		if = {
			limit = {
				ARA = { has_ruler_flag = isabella }
			}
			ARA = { kill_ruler = yes }
		}
		if = {
			limit = {
				CAS = { has_ruler_flag = isabella }
			}
			CAS = { kill_ruler = yes }
		}
		ARA = { create_union = CAS }
	}
}

# Heir Dies #
country_event = {
	id = castilian_civil_war.31
	title = "castilian_civil_war.31.t"
	desc = "castilian_civil_war.31.d"
	picture = DEATH_OF_HEIR_eventPicture

	fire_only_once = yes

	trigger = {
		tag = CAS
		NOT = { has_disaster = castilian_civil_war }
		OR = {
			# Castile Isabel died
			AND = {
				POR = {
					has_heir_flag = isabel
				}
				CAS = {
					NOT = { has_heir_flag = isabel }
					NOT = { has_ruler_flag = isabel }
				}
			}
			# Portugal Isabel died
			AND = {
				CAS = {
					has_heir_flag = isabel
				}
				POR = {
					NOT = { has_heir_flag = isabel }
					NOT = { has_ruler_flag = isabel }
				}
			}
			# Castile Joanna died
			AND = {
				ARA = {
					has_heir_flag = joanna
				}
				CAS = {
					NOT = { has_heir_flag = joanna }
					NOT = { has_ruler_flag = joanna }
				}
			}
			# Aragon Joanna died
			AND = {
				CAS = {
					has_heir_flag = joanna
				}
				ARA = {
					NOT = { has_heir_flag = joanna }
					NOT = { has_ruler_flag = joanna }
				}
			}
		}
	}

	option = {
		name = "castilian_civil_war.31a"

		trigger = {
			POR = {
				has_heir_flag = isabel
			}
			CAS = {
				NOT = { has_heir_flag = isabel }
				NOT = { has_ruler_flag = isabel }
			}
		}

		POR = {
			kill_heir = { allow_new_heir = yes }
		}
	}

	option = {
		name = "castilian_civil_war.31b"

		trigger = {
			CAS = {
				has_heir_flag = isabel
			}
			ARA = {
				NOT = { has_heir_flag = isabel }
				NOT = { has_ruler_flag = isabel }
			}
		}

		CAS = {
			kill_heir = { allow_new_heir = yes }
		}
	}

	option = {
		name = "castilian_civil_war.31c"

		trigger = {
			ARA = {
				has_heir_flag = joanna
			}
			CAS = {
				NOT = { has_heir_flag = joanna }
				NOT = { has_ruler_flag = joanna }
			}
		}

		ARA = {
			kill_heir = { allow_new_heir = yes }
		}
	}

	option = {
		name = "castilian_civil_war.31d"

		trigger = {
			CAS = {
				has_heir_flag = joanna
			}
			ARA = {
				NOT = { has_heir_flag = joanna }
				NOT = { has_ruler_flag = joanna }
			}
		}

		CAS = {
			kill_heir = { allow_new_heir = yes }
		}
	}
}